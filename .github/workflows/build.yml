name: Build Qualcomm Linux

on:
  workflow_call:

env:
  BASE_ARTIFACT_URL: "https://quic-yocto-fileserver-1029608027416.us-central1.run.app/${{ github.run_id }}"
  MANIFEST_URL: https://github.com/quic-yocto/qcom-manifest
  MANIFEST_BRANCH: qcom-linux-scarthgap
  QLI_VERSION: QLI.1.4

jobs:
  build:
    if: github.repository == 'qualcomm-linux/meta-qcom-3rdparty'
    strategy:
      fail-fast: true
      matrix:
        machine:
          - qcs6490-rb3gen2-core-kit
          - qcs6490-rb3gen2-vision-kit
          - qcs9075-ride-sx
          - qcs9075-rb8-core-kit
          - qcs9100-ride-sx
          - qcs8300-ride-sx
        bsp:
          - custom
        include:
          - machine: qcs9100-ride-sx
            bsp: base
          - machine: qcs8300-ride-sx
            bsp: base
    runs-on: [self-hosted, qcom-u2404, amd64-ssd]
    container:
      image: debian:trixie
      volumes:
        - /efs/qli/meta-qcom-3rdparty:/cache
      options: --privileged
    steps:
      - name: Update OS packages
        run: |
          set -ux
          sed -i 's/Components: main/Components: main contrib/' /etc/apt/sources.list.d/debian.sources
          apt update
          apt -y upgrade
          apt -y full-upgrade
          apt-get install --no-install-recommends -y \
             build-essential chrpath cpio debianutils diffstat file gawk \
             gcc git iputils-ping libacl1 locales python3 python3-git \
             python3-jinja2 python3-pexpect python3-pip python3-subunit \
             socat texinfo unzip wget xz-utils zstd repo ssh

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get manifest file
        run: |
          git clone --depth=1 ${MANIFEST_URL} -b ${MANIFEST_BRANCH}
          cd qcom-manifest
          MANIFEST_FILE=$(ls *${QLI_VERSION}*.xml | sort | grep -v -e realtime-linux -e qim-product-sdk -e robotics-product-sdk | tail -1)
          echo "Manifest file: ${MANIFEST_FILE}"
          echo "MANIFEST_FILE=${MANIFEST_FILE}" >> "$GITHUB_ENV"

      - name: Setup workspace
        run: |
          mkdir QLI
          cd QLI
          repo init -u ${MANIFEST_URL} -b ${MANIFEST_BRANCH} -m ${MANIFEST_FILE}
          repo sync
          mkdir -p /cache/{downloads,sstate-cache}
          ln -s /cache/downloads
          ln -s /cache/sstate-cache

      - name: Build QLI
        run: |
          cd QLI
          # FIXME: apply_poky_patches() fails in setup-environment and it's not
          # needed, so skip it for now, until it's fixed properly.
          sed -i '/    apply_poky_patches/d' setup-environment
          MACHINE=${{ matrix.machine }} DISTRO=qcom-wayland QCOM_SELECTED_BSP=${{ matrix.bsp }} source setup-environment
          bitbake-layers add-layer $GITHUB_WORKSPACE
          bitbake qcom-console-image
